<script>
    // NOVA FUNÇÃO DE INTELIGÊNCIA SEQUENCIAL
    async function verificarJornada() {
        const idPaciente = document.getElementById('pacienteID').value;
        if (!idPaciente) {
            alert("Por favor, digite o ID do paciente primeiro.");
            return;
        }

        // Busca no Firebase quantos registros existem para este ID (codificado)
        const idCoded = btoa(idPaciente);
        const snapshot = await db.collection("atendimentos_360")
                                 .where("id", "==", idCoded)
                                 .get();

        const totalSessoes = snapshot.size;
        const proximaSessao = totalSessoes + 1;

        if (proximaSessao > 12) {
            alert("Paciente já completou o ciclo de 12 sessões. Iniciando ciclo de manutenção.");
        }

        // Atualiza o seletor automaticamente
        document.getElementById('sessaoNum').value = proximaSessao;
        
        // Feedback visual para o Mestre
        const label = document.querySelector('label[for="sessaoNum"]');
        label.innerHTML = `SESSÃO ATUAL: <span class="badge bg-success">${proximaSessao}º atendimento</span>`;
    }
</script>
