<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M칄TODO 360 PRO | V. 11.5</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --dark: #000d1a; --primary: #002d58; --accent: #c5a059; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: sans-serif; margin: 0; padding-bottom: 80px; }
        #loginScreen { background: linear-gradient(135deg, var(--dark) 0%, var(--primary) 100%); height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; width: 100%; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-bottom: 8px solid var(--accent); }
        #mainContent { display: none; padding: 20px; max-width: 1100px; margin: auto; }
        .card-pro { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 15px solid var(--primary); margin-bottom: 20px; }
        .etapa { display: none; }
        .ativa { display: block; }
        .titulo-secao { color: var(--accent); font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 20px 0 10px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
        .btn-pro { background: var(--primary); color: white; padding: 15px; border-radius: 10px; border: none; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-stats { background: var(--accent); color: white; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: 20px 0; background: #fff; border-radius: 10px; padding: 10px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: var(--primary); color: white; }
        .row { display: flex; flex-wrap: wrap; gap: 10px; }
        .col { flex: 1; min-width: 250px; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <h2 style="color:var(--primary); margin:0;">M칄TODO 360 PRO</h2>
        <input type="password" id="pinInput" placeholder="PIN" style="text-align:center; font-size:1.5rem;">
        <button class="btn-pro" onclick="autenticar()">DESBLOQUEAR</button>
    </div>
</div>

<div id="mainContent">
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn-pro" onclick="ir(1)" style="flex:1">游뽘 ATENDIMENTO</button>
        <button class="btn-pro btn-stats" onclick="abrirDashboard()" style="flex:1">游늵 ESTAT칈STICAS</button>
    </div>

    <div id="e0" class="etapa">
        <div class="card-pro">
            <h5 class="titulo-secao">游댍 PESQUISA POR PACIENTE</h5>
            <div class="row">
                <div class="col"><input type="text" id="buscaID" placeholder="Digite ID do Paciente (Ex: MRO5005)"></div>
                <div class="col"><button class="btn-pro" onclick="analisarPaciente()" style="margin:0;">GERAR GR츼FICO E RELAT칍RIO</button></div>
            </div>
            
            <div id="areaGrafico" style="display:none;">
                <div class="chart-container">
                    <canvas id="chartEvolucao"></canvas>
                </div>
                <div id="relatorioIndividual"></div>
            </div>
        </div>
    </div>

    <div id="e1" class="etapa ativa">
        <div class="card-pro">
            <h5 class="titulo-secao">NOVA SESS츾O</h5>
            <p>Selecione a Central de Estat칤sticas para ver os gr치ficos hist칩ricos.</p>
        </div>
    </div>
</div>

<script>
    // Configura칞칚o Firebase
    const firebaseConfig = { apiKey: "AIzaSyAI5X-Cb0Xf0G_cRoBX9YWqW1bn0nv-RA", authDomain: "metodo360pro-db0aa.firebaseapp.com", projectId: "metodo360pro-db0aa", storageBucket: "metodo360pro-db0aa.firebasestorage.app", messagingSenderId: "1088396585788", appId: "1:1088396585788:web:57853a7b0ff17c8306ec39" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let meuGrafico = null;

    function autenticar() {
        if(document.getElementById('pinInput').value === "1234") {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
    }

    function ir(n) {
        document.querySelectorAll('.etapa').forEach(e => e.classList.remove('ativa'));
        document.getElementById('e'+n).classList.add('ativa');
    }

    function abrirDashboard() { ir(0); }

    async function analisarPaciente() {
        const idBusca = document.getElementById('buscaID').value.trim().toUpperCase();
        if(!idBusca) return alert("Digite um ID");

        try {
            // Busca com suporte a m칰ltiplos nomes de campo (paciente ou id)
            const snap = await db.collection("atendimentos_360")
                .where("paciente", "==", idBusca)
                .get();

            if(snap.empty) {
                return alert("Nenhum dado encontrado para este ID.");
            }

            let dados = [];
            snap.forEach(doc => {
                let d = doc.data();
                // Normaliza칞칚o da data (Firebase Timestamp para JS Date)
                let dataJS = d.data.seconds ? new Date(d.data.seconds * 1000) : new Date(d.data);
                dados.push({ ...d, dataJS: dataJS });
            });

            // Ordenar por data
            dados.sort((a, b) => a.dataJS - b.dataJS);

            // Preparar Gr치fico
            let labels = dados.map(d => d.dataJS.toLocaleDateString());
            let valoresEVA = dados.map(d => d.eva ? d.eva[1] : 0);

            document.getElementById('areaGrafico').style.display = 'block';
            
            const ctx = document.getElementById('chartEvolucao').getContext('2d');
            if(meuGrafico) meuGrafico.destroy();
            
            meuGrafico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Evolu칞칚o EVA (Dor/Stress)',
                        data: valoresEVA,
                        borderColor: '#c5a059',
                        backgroundColor: 'rgba(197, 160, 89, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 10 } }
                }
            });

            // Gerar Tabela de Relat칩rio
            let html = `<table><thead><tr><th>Data</th><th>Sess칚o</th><th>EVA F.</th><th>Conduta Tung</th></tr></thead><tbody>`;
            dados.forEach(d => {
                html += `<tr>
                    <td>${d.dataJS.toLocaleDateString()}</td>
                    <td>${d.sessao || '-'}</td>
                    <td>${d.eva ? d.eva[1] : '-'}</td>
                    <td>${d.diagnostico || d.diag || 'Sem notas'}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('relatorioIndividual').innerHTML = html;

        } catch (e) {
            console.error(e);
            alert("Erro ao gerar gr치ficos. Verifique o console.");
        }
    }
</script>
</body>
</html>
