<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <style>
        /* Apenas um estilo para o alerta de mem√≥ria que aparece no topo */
        .alerta-memoria { background: #fffcf0; border-left: 10px solid #c5a059; padding: 15px; margin-bottom: 20px; border-radius: 10px; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="loginScreen">
    </div>

<div id="mainContent">
    <div id="painelMemoria" class="alerta-memoria">
        <h4 style="margin:0; color:#002d58;">üîé SUBS√çDIO DE RETROSPECTIVA</h4>
        <div id="conteudoMemoria" style="font-size: 0.85rem; margin-top:10px;"></div>
    </div>

    <div class="card-pro">
        <div id="e1" class="etapa ativa">
            <h5 class="titulo-secao">1. Identifica√ß√£o & Hist√≥ria Cl√≠nica</h5>
            <div class="row">
                <div class="col"><label class="small fw-bold">ID / INICIAIS:</label><input type="text" id="pacienteID" onblur="buscarHistoricoInteligente()"></div>
                </div>
            </div>

        <div id="e5" class="etapa">
            <h5 class="titulo-secao">5. S√≠ntese Cl√≠nica & Ponto Aberto</h5>
            <textarea id="diag" placeholder="Anote aqui seu diagn√≥stico, conduta Tung e observa√ß√µes de Chakras/Epigen√©tica..." rows="8" style="margin-top:10px;"></textarea>
            
            <button class="btn-pro" style="background:black" onclick="copiarIAInteligente()">COPIAR IA BRIDGE (COM SCANNER)</button>
            <button class="btn-pro" style="background:green" onclick="salvarFB()">SALVAR NO FIREBASE</button>
        </div>
    </div>
</div>

<script>
    // ... (Suas vari√°veis e conex√£o Firebase originais) ...

    // --- üöÄ NOVO: Scanner de Desajustes na Anamnese ---
    function copiarIAInteligente() {
        const textoLivre = document.getElementById('hma').value + " " + document.getElementById('diag').value;
        const categorias = {
            "Energ√©tico": ["chakra", "plexo", "meridiano", "qi", "estagna√ß√£o"],
            "Mental/Emocional": ["trauma", "ansiedade", "mental", "emocional", "cren√ßa"],
            "Epigen√©tico": ["fam√≠lia", "heran√ßa", "estilo de vida", "gen√©tico"]
        };

        let detectados = [];
        for (let cat in categorias) {
            categorias[cat].forEach(termo => {
                if (textoLivre.toLowerCase().includes(termo)) detectados.push(cat + ": " + termo);
            });
        }

        const t = `[M√âTODO 360 PROMAX]\nID: ${document.getElementById('pacienteID').value}\n` +
                  `DETEC√á√ÉO CL√çNICA: ${[...new Set(detectados)].join(' | ')}\n` +
                  `EVA: ${evaA}->${evaD} | GAD: ${scG} | IGI: ${scI}\n` +
                  `CONDUTA: ${document.getElementById('diag').value}`;

        navigator.clipboard.writeText(t).then(() => alert("Copiado com Scanner de Desajustes!"));
    }

    // --- üìú NOVO: Busca Retrospectiva que l√™ as anota√ß√µes ---
    async function buscarHistoricoInteligente() {
        const id = document.getElementById('pacienteID').value.trim().toUpperCase();
        if(!id || !db) return;

        try {
            const snapshot = await db.collection("atendimentos_360")
                .where("paciente", "==", id).orderBy("data", "desc").limit(3).get();

            if (!snapshot.empty) {
                let resumo = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    resumo += `‚Ä¢ <b>Sess√£o ${d.sessao}:</b> EVA Final ${d.eva[1]} | Nota: <i>"${d.diagnostico.substring(0,90)}..."</i><br>`;
                });
                document.getElementById('conteudoMemoria').innerHTML = resumo;
                document.getElementById('painelMemoria').style.display = "block";
            }
        } catch(e) { console.log(e); }
    }

    // ... (Mantendo todas as suas fun√ß√µes originais: setSc, init, setPulse, salvarFB etc.) ...
</script>
</body>
</html>
